name: Payments Reconcile

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: payments-reconcile
  cancel-in-progress: false

jobs:
  reconcile:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.9.0"
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Install web deps
        run: npm --prefix web ci

      - name: Run server auth guard
        run: npm --prefix web run guard:no-server-getsession

      - name: Run next image optimisation guard
        run: npm --prefix web run guard:next-image-optimisation

      - name: Run shortlets perf budgets guard
        run: npm --prefix web run guard:shortlets-perf

      - name: Call payments reconcile endpoints
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          set -euo pipefail

          if [ -z "${APP_URL:-}" ]; then
            echo "Missing required secret: APP_URL"
            exit 1
          fi

          if [ -z "${CRON_SECRET:-}" ]; then
            echo "Missing required secret: CRON_SECRET"
            exit 1
          fi

          ATTEMPTS=3
          SLEEP_SECONDS=10
          call_endpoint() {
            local endpoint="$1"
            local reconcile_url="${APP_URL%/}${endpoint}"
            local attempt=1
            local success=0
            local response_file

            response_file="$(mktemp)"

            echo "Reconcile URL: ${reconcile_url}"

            while [ "${attempt}" -le "${ATTEMPTS}" ]; do
              echo "[${endpoint}] Attempt ${attempt}/${ATTEMPTS}"

              if ! http_code="$(curl -sS \
                -o "${response_file}" \
                -w "%{http_code}" \
                -X POST "${reconcile_url}" \
                -H "x-cron-secret: ${CRON_SECRET}" \
                -H "content-type: application/json" \
                --data '{}')"; then
                http_code="curl_error"
              fi

              echo "[${endpoint}] HTTP status: ${http_code}"
              echo "[${endpoint}] Response body (first 2048 bytes):"
              head -c 2048 "${response_file}" || true
              echo ""

              if [[ "${http_code}" =~ ^[0-9]{3}$ ]] && [ "${http_code}" -ge 200 ] && [ "${http_code}" -lt 300 ]; then
                success=1
                break
              fi

              if [ "${attempt}" -lt "${ATTEMPTS}" ]; then
                echo "[${endpoint}] Request failed; retrying in ${SLEEP_SECONDS}s..."
                sleep "${SLEEP_SECONDS}"
              fi

              attempt=$((attempt + 1))
            done

            if [ "${success}" -ne 1 ]; then
              echo "[${endpoint}] Reconcile failed after ${ATTEMPTS} attempts."
              rm -f "${response_file}"
              exit 1
            fi

            rm -f "${response_file}"
          }

          call_endpoint "/api/jobs/payments/reconcile"
          call_endpoint "/api/internal/shortlet/reconcile-payments"
