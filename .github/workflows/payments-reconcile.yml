name: Payments Reconcile

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: payments-reconcile
  cancel-in-progress: false

jobs:
  reconcile:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Call payments reconcile endpoint
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          set -euo pipefail

          if [ -z "${APP_URL:-}" ]; then
            echo "Missing required secret: APP_URL"
            exit 1
          fi

          if [ -z "${CRON_SECRET:-}" ]; then
            echo "Missing required secret: CRON_SECRET"
            exit 1
          fi

          RECONCILE_URL="${APP_URL%/}/api/jobs/payments/reconcile"
          echo "Reconcile URL: ${RECONCILE_URL}"

          ATTEMPTS=3
          SLEEP_SECONDS=10
          attempt=1
          success=0
          response_file="$(mktemp)"
          trap 'rm -f "${response_file}"' EXIT

          while [ "${attempt}" -le "${ATTEMPTS}" ]; do
            echo "Attempt ${attempt}/${ATTEMPTS}"

            if ! http_code="$(curl -sS \
              -o "${response_file}" \
              -w "%{http_code}" \
              -X POST "${RECONCILE_URL}" \
              -H "x-cron-secret: ${CRON_SECRET}" \
              -H "content-type: application/json" \
              --data '{}')"; then
              http_code="curl_error"
            fi

            echo "HTTP status: ${http_code}"
            echo "Response body (first 2048 bytes):"
            head -c 2048 "${response_file}" || true
            echo ""

            if [[ "${http_code}" =~ ^[0-9]{3}$ ]] && [ "${http_code}" -ge 200 ] && [ "${http_code}" -lt 300 ]; then
              success=1
              break
            fi

            if [ "${attempt}" -lt "${ATTEMPTS}" ]; then
              echo "Request failed; retrying in ${SLEEP_SECONDS}s..."
              sleep "${SLEEP_SECONDS}"
            fi

            attempt=$((attempt + 1))
          done

          if [ "${success}" -ne 1 ]; then
            echo "Payments reconcile failed after ${ATTEMPTS} attempts."
            exit 1
          fi
