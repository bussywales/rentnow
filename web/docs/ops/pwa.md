# PWA Ops

## Installability
- Manifest: `/manifest.webmanifest` (generated by `web/app/manifest.ts`).
- Icons: `/public/icons/icon-192.png`, `/public/icons/icon-512.png`.

Verify in Chrome DevTools → Application → Manifest that the app is installable.

## Service worker behavior
Service worker script: `/sw.js`

Cached:
- `/_next/static/*`
- `/icons/*`
- `/icon.svg`
- `/offline`

Never cached:
- `/api/*`
- `/auth/*`
- `/dashboard/*`
- `/admin/*`
- `/proxy/auth`

Navigation fallback:
- When offline, document navigations fall back to `/offline`.

## Offline verification
1) Visit `/offline` once (to warm the cache).
2) In DevTools → Application → Service Workers, confirm the SW is active.
3) Set the browser to Offline and refresh a public page; `/offline` should render.
4) Confirm `/dashboard` and `/admin` are not cached (network error or offline page).

## Push notifications (Web Push)
Required env vars (do not commit secrets):
- `VAPID_PUBLIC_KEY`
- `VAPID_PRIVATE_KEY`
- `VAPID_SUBJECT` (optional, mailto or site URL)
- `NEXT_PUBLIC_VAPID_PUBLIC_KEY` (client access)

Endpoints:
- `POST /api/push/subscribe`
- `POST /api/push/unsubscribe`
- `GET /api/push/status`

Behavior:
- Push only delivers alerts; no sensitive data is cached or stored in the service worker.
- If VAPID keys are missing, push endpoints return a 503-style response.
- Stale subscriptions are pruned automatically when the provider reports a permanent failure (404/410).
- Saved searches page shows a “Notifications currently unavailable” card when push is not configured.
- Tenant saved-search pushes include only a short title, city, and property link (no user or search names).
- Per-tenant per-property push dedupe is enforced via `public.saved_search_push_dedup`.

Verification:
1) Ensure the VAPID keys are set in the environment.
2) Visit `/dashboard/saved-searches` and use the Push badge to enable notifications.
3) Confirm a row appears in `public.push_subscriptions`.
4) Trigger a saved search alert; confirm a push notification appears and clicks through to the listing.
5) Trigger the same property again and confirm the tenant does not receive a duplicate push.

Push alert verification query (uses `user_id`):
```sql
select id, user_id, saved_search_id, property_id, channel, status, error, created_at, sent_at
from public.saved_search_alerts
where channel like '%push%'
order by created_at desc
limit 50;
```

Troubleshooting markers (saved_search_alerts.error):
- `push_unavailable:not_configured` → missing VAPID keys.
- `push_unavailable:missing_subscription` → user has no active subscription.
- `push_unavailable:subscription_lookup_failed` → DB query failed.
- `push_failed:rate_limited` or `push_failed:provider_error` → delivery issues.
- `push_pruned:gone` → subscription was removed after a permanent failure; user must re-enable.

Tenant UX:
- When a subscription is pruned, the Push badge shows “Notifications need to be re-enabled.”
- If permission is granted but no active subscription exists, the CTA shows “Finish setup.”
- If permission is not yet granted, the CTA shows “Enable notifications.”

Admin support:
- `/admin/support` shows “Push configured: Yes/No”.
- Missing VAPID keys are listed only in dev mode or when `?debug=1` is supplied.
- Delivery telemetry appears under “Recent delivery attempts” (admin-only) and persists in `push_delivery_attempts`.
- Tenant saved-search push attempts appear under “Tenant push (saved searches)” with last 24h/7d counts.
- Debug-only reason codes are shown in dev or when `?debug=1` is supplied.

Admin test push:
- `/admin/support` includes “Send test push” for admins.
- Test push targets only the current admin’s own subscriptions.
- If no subscription exists, the API returns `code=no_subscriptions`.
- If the endpoint returns `Unauthorized`, re-authenticate and retry; the route no longer clears cookies on parse failures.

R14.5 readiness checklist:
1) Confirm VAPID keys are configured in the environment.
2) Visit `/admin/support` and review the Push readiness rows.
3) Enable notifications when permission is default.
4) Create a subscription when permission is granted.
5) Send a test push to confirm delivery and telemetry updates.

Retention cleanup (manual):
```sql
select count(*) as candidate_rows
from public.saved_search_alerts
where created_at < (now() - interval '60 days')
  and channel ilike '%push%';

select public.cleanup_push_alerts(60) as deleted_rows;
```

Notes:
- Run in the Supabase SQL editor (admin context).
- Cleanup only targets alert rows with push in the channel; subscriptions are not deleted here.
- Safety check: `deleted_rows` should be less than or equal to `candidate_rows`.
